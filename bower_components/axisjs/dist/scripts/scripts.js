"use strict";angular.module("axisJSApp",["ngAnimate","ngResource","ngSanitize","ui"]),angular.module("axisJSApp").provider("configProvider",function(){this.$get=["$http","$q",function(a,b){var c=a.get("default.config.yaml"),d=a.get("config.yaml").then(function(a){return a.data},function(a){return 404===a.status?(a.data={},a):b.reject(a)});return b.all([c,d]).then(function(a){var b=jsyaml.safeLoad(a[0].data),c=jsyaml.safeLoad(a[1].data);return c="undefined"!==c?c:{},angular.extend(b,c)})}]}),angular.module("axisJSApp").controller("MainCtrl",["configProvider","$scope",function(a,b){a.then(function(a){b.appConfig=a,b.inputs={},b.columns=[],b.chartData={},b.config={data:{x:"",y:"",y2:"",columns:[["data1",30,200,100,400,150,250],["data2",50,20,10,40,15,25]],axes:{},groups:{},type:"",types:{data1:"line",data2:"line"},colors:{data1:a.colors[0].value,data2:a.colors[1].value}},axis:{x:{show:!0},y:{show:!0},y2:{show:!1}},point:{show:!1},legend:{position:"bottom",show:!0}},b.chartTypes=["line","step","area","area-step","scatter","bar","spline"],b.config.groups={},b.inputs.csvData="data1	data2\n30	50\n200	20\n100	10\n400	40\n150	15\n250	25",b.config.axis.x.show=!0,b.config.axis.y.show=!0,b.config.axis.y2.show=!1,b.config.axis.x.accuracy=0,b.config.axis.y.accuracy=0,b.config.axis.y2.accuracy=0,b.config.axis.x.prefix="",b.config.axis.y.prefix="",b.config.axis.y2.prefix="",b.config.axis.x.suffix="",b.config.axis.y.suffix="",b.config.axis.y2.suffix="",b.config.axis.x.tick={format:function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.x.type?b.config.axis.x.prefix+a.toFixed(b.config.axis.x.accuracy).toString()+b.config.axis.x.suffix:a}},b.config.axis.y.tick={format:function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.y.type?b.config.axis.y.prefix+a.toFixed(b.config.axis.y.accuracy).toString()+b.config.axis.y.suffix:a}},b.config.axis.y2.tick={format:function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.y2.type?b.config.axis.y2.prefix+a.toFixed(b.config.axis.y2.accuracy).toString()+b.config.axis.y2.suffix:a}},b.config.chartTitle="",b.config.chartCredit="",b.config.chartSource="",b.config.chartWidth=1e3,b.config.chartGlobalType="series",b.config.chartAccuracy=1,b.config.cms="undefined"!=typeof parent.tinymce?!0:!1,b.config.pie={label:{format:function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"}}},b.config.donut={label:{format:function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"}}},b.config.gauge={label:{format:function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"}}},b.updateData=function(){if(b.inputs.csvData){b.chartData=[],b.columns=[],b.config.data.columns=[];var a={header:!0};b.inputs.csvData.match("	")&&(a.delimiter="	"),b.chartData=Papa.parse(b.inputs.csvData,a).data,b.chartData.length>0&&(b.columns=Object.keys(b.chartData[0]),angular.forEach(b.columns,function(a){var c=[];c.push(a),angular.forEach(b.chartData,function(b){c.push(b[a])}),b.config.data.columns.push(c),"undefined"==typeof b.config.data.types[a]&&(b.config.data.types[a]="series"===b.config.chartGlobalType?"line":b.config.chartGlobalType)}))}},b.validateCSV=function(a){var b={header:!0};a.match("	")&&(b.delimiter="	");var c=Papa.parse(a,b),d=/^[^,\t\s]*\n[^,\t\s]*$/gm;return c.errors.length>0&&!a.match(d)?!1:!0},b.setGlobalType=function(a){for(var c in b.config.data.types)b.config.data.types.hasOwnProperty(c)&&(b.config.data.types[c]="series"!==a?a:"line")},b.setGroups=function(){b.config.data.groups=[];for(var a in b.config.groups)b.config.groups.hasOwnProperty(a)&&("undefined"==typeof b.config.data.groups[b.config.groups[a]]&&(b.config.data.groups[b.config.groups[a]]=[]),b.config.data.groups[b.config.groups[a]].push(a))},b.updateData(),window.getConfig=function(){console.dir(b.config),window.chartConfig=b.config},"undefined"!=typeof parent.tinymce&&"undefined"!=typeof parent.tinymce.activeEditor.windowManager.getParams().axisJS&&(b.config=angular.fromJson(window.atob(parent.tinymce.activeEditor.windowManager.getParams().axisJS)),b.config.axis.x.tick.format=function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.x.type?b.config.axis.x.prefix+a.toFixed(b.config.axis.x.accuracy).toString()+b.config.axis.x.suffix:a},b.config.axis.y.tick.format=function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.y.type?b.config.axis.y.prefix+a.toFixed(b.config.axis.y.accuracy).toString()+b.config.axis.y.suffix:a},b.config.axis.y2.tick.format=function(a){return"series"===b.config.chartGlobalType&&"category"!==b.config.axis.y2.type?b.config.axis.y2.prefix+a.toFixed(b.config.axis.y2.accuracy).toString()+b.config.axis.y2.suffix:a},b.config.donut.label.format=function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"},b.config.pie.label.format=function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"},b.config.gauge.label.format=function(a,c){return(100*c).toFixed(b.config.chartAccuracy)+"%"},b.updateData())})}]),angular.module("axisJSApp").directive("buildChart",["$timeout",function(a){return{restrict:"A",link:function(b,c){function d(){var a,c,d,e,f=d3.select("svg"),g=f.attr("width");for(null!==f.select("text.titles")[0][0]?(a=f.select("text.titles"),c=a.select("tspan.chartTitle"),d=a.select("tspan.chartCredit"),e=a.select("tspan.chartSource")):(a=f.insert("text").attr("class","titles").attr("text-anchor","middle"),c=a.insert("tspan").attr("class","chartTitle"),d=a.insert("tspan").attr("class","chartCredit"),e=a.insert("tspan").attr("class","chartSource")),c.text(b.config.chartTitle).attr("font-size","32px"),d.text(b.config.chartCredit).attr("font-size","30px"),e.text(b.config.chartSource).attr({"font-size":"28px","font-style":"oblique"}),c.attr({dy:0,x:0}),d.attr({dy:32,x:0}),e.attr({dy:30,x:0});c.node().getComputedTextLength()>g||d.node().getComputedTextLength()>g||e.node().getComputedTextLength()>g;){var h=parseInt(c.attr("font-size").replace("px",""))-1,i=parseInt(d.attr("font-size").replace("px",""))-1,j=parseInt(e.attr("font-size").replace("px",""))-1;c.attr("font-size",h+"px"),d.attr("font-size",i+"px"),e.attr("font-size",j+"px"),d.attr({dy:h,x:0}),e.attr({dy:i,x:0})}a.attr("width",g).attr("transform","translate("+g/2+",350)"),f.attr("height",f.node().getBBox().height+"px")}function e(){f=c3.generate({bindto:"#"+c[0].id,data:{x:b.config.data.x,y:b.config.data.y,y2:b.config.data.y2,columns:b.config.data.columns,axes:b.config.data.axes,types:b.config.data.types,colors:b.config.data.colors,groups:b.config.data.groups},axis:b.config.axis,legend:b.config.legend,point:b.config.point,pie:b.config.pie,donut:b.config.donut,gauge:b.config.gauge,color:{pattern:b.config.defaultColors}}),a(function(){d()})}c.children("svg").attr("transform","scale(2)");var f;e(),b.$watch("config.data.columns",function(){e();for(var a in f.data.colors())b.config.data.colors[a]=f.data.colors()[a]}),b.$watch("config.data.colors",function(){f.data.colors(b.config.data.colors)},!0),b.$watch("config.data.types",function(){e()},!0),b.$watch("config.axis",function(a){for(var c in a)if(a.hasOwnProperty(c)){if(a[c].hasOwnProperty("label")){var d={};d[c]=a[c].label,f.axis.labels(d)}(a[c].hasOwnProperty("show")||a[c].hasOwnProperty("max")||a[c].hasOwnProperty("min"))&&e(),(a[c].hasOwnProperty("prefix")||a[c].hasOwnProperty("suffix")||a[c].hasOwnProperty("accuracy"))&&(b.config.axis[c].prefix="undefined"==typeof a[c].prefix?"":a[c].prefix,b.config.axis[c].suffix="undefined"==typeof a[c].suffix?"":a[c].suffix,b.config.axis[c].accuracy="undefined"==typeof a[c].accuracy?0:a[c].accuracy)}},!0),b.$watchGroup(["config.data.x","config.data.y","config.data.y2"],function(a){a.forEach(function(a,c){var d=0===c?"x":1===c?"y":2===c?"y2":"";b.config.data.columns.forEach(function(c){for(var e=1;e<c.length;e++)if(isNaN(c[e])&&c[0]===a){b.config.axis[d].type="category",b.config.axis[d].tick=void 0;break}})}),e()}),b.$watchGroup(["config.chartTitle","config.chartCredit","config.chartSource","config.chartAccuracy","config.legend.position","config.legend.show"],function(){e()}),b.$watch("config.data.groups",function(){e()},!0)}}}]),angular.module("axisJSApp").directive("exportChart",function(){return{restrict:"A",link:function(a,b,c){b.on("click",function(){switch(c.exportChart){case"cms":e(a.config.chartWidth);var b=a.config;b.axis.x.tick.format=b.axis.x.tick.format.toString(),b.axis.y.tick.format=b.axis.y.tick.format.toString(),b.axis.y2.tick.format=b.axis.y2.tick.format.toString(),b.pie.label.format=b.pie.label.format.toString(),b.donut.label.format=b.donut.label.format.toString(),b.gauge.label.format=b.gauge.label.format.toString();var d=String(angular.toJson(b)),f=String(angular.element(".savePNG").attr("href")),g=parent.tinymce.activeEditor.windowManager.getParams().axisWP,h={action:"insert_axis_attachment",axisConfig:d,axisChart:f,parentID:g.parentID};$.post(parent.ajaxurl,h,function(a){a=angular.fromJson(a),parent.tinymce.activeEditor.insertContent('<div class="mceNonEditable"><img src="'+a.attachmentURL+"\" data-axisjs='"+window.btoa(angular.toJson(a))+'\' class="mceItem axisChart" /></div><br />'),parent.tinymce.activeEditor.windowManager.close()});break;case"images":e(a.config.chartWidth)}});var d,e=function(b){angular.element("defs").remove(),f();var c=angular.element("#canvas").empty()[0];if(b){var d=b/angular.element("#chart").width();angular.element("#chart > svg").attr("transform","scale("+d+")"),c.width=angular.element("#chart > svg").width()*d,c.height=angular.element("#chart > svg").height()*d}else angular.element("#chart > svg").attr("transform","scale(2)"),c.width=2*angular.element("#chart > svg").width(),c.height=2*angular.element("#chart > svg").height();var e=c.getContext("2d"),g=document.getElementsByTagName("svg")[0],i=new XMLSerializer;g=i.serializeToString(g),e.drawSvg(g,0,0);for(var j=[],k=0;k<a.columns.length;k++)j.push(a.columns[k]);a.chartTitle&&j.unshift(a.chartTitle),j=j.join("-").replace(/[^\w\d]+/gi,"-"),angular.element(".savePNG").attr("href",c.toDataURL("png")).attr("download",function(){return j+"_axisJS.png"});var l=h(angular.element("#chart > svg")[0]);$(".saveSVG").attr("href","data:text/svg,"+l.source[0]).attr("download",function(){return j+"_axisJS.svg"})},f=function(){for(var a,b,c=0;c<=document.styleSheets.length-1;c++)document.styleSheets[c].href&&-1!==document.styleSheets[c].href.indexOf("c3.css")&&(a=void 0!==document.styleSheets[c].rules?document.styleSheets[c].rules:document.styleSheets[c].cssRules);if(null!==a&&void 0!==a){var e=function(){("hidden"===angular.element(this).css("visibility")||"0"===angular.element(this).css("opacity"))&&angular.element(this).css("display","none")};for(c=0;c<a.length;c++)1===a[c].type&&(b=a[c].selectorText,d=g(a[c]),angular.element("svg *").each(e),angular.element(b).not(".c3-chart path").css(d)),angular.element(".c3-chart path").filter(function(){return"none"===angular.element(this).css("fill")}).attr("fill","none"),angular.element(".c3-chart path").filter(function(){return"none"!==angular.element(this).css("fill")}).attr("fill",function(){return angular.element(this).css("fill")})}},g=function(a){var b,c=a.style,d={};for(b=0;b<c.length;b++)d[c[b]]=c[c[b]];return d},h=function(a){var b={xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:"http://www.w3.org/2000/svg"},c='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';a.setAttribute("version","1.1");var e=document.createElement("style");e.setAttribute("type","text/css"),a.removeAttribute("xmlns"),a.removeAttribute("xlink"),a.hasAttributeNS(b.xmlns,"xmlns")||a.setAttributeNS(b.xmlns,"xmlns",b.svg),a.hasAttributeNS(b.xmlns,"xmlns:xlink")||a.setAttributeNS(b.xmlns,"xmlns:xlink",b.xlink);var f=(new XMLSerializer).serializeToString(a).replace("</style>","<![CDATA["+d+"]]></style>");return f=f.replace(/\sfont-.*?: .*?;/gi,""),f=f.replace(/\sclip-.*?="url\(http:\/\/.*?\)"/gi,""),f=f.replace(/\stransform="scale\(2\)"/gi,""),f=f.replace(/<defs xmlns="http:\/\/www.w3.org\/1999\/xhtml">/gi,"<defs>"),{svg:a,source:[c+f]}}}}}),angular.module("axisJSApp").directive("addColors",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){c.children("option").each(function(){var a=angular.element(this);a.attr("data-color",a.text())}),c.colorselector()},500)}}}]);